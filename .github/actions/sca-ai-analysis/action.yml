name: SCA AI Analysis
description: Run Trivy SCA scan and analyze results with OpenAI
inputs:
  openai-api-key:
    required: true
    description: OpenAI API key for remediation suggestions

runs:
  using: "composite"
  steps:
    - name: Install Trivy
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y wget tar
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.66.0_Linux-64bit.tar.gz
        tar zxvf trivy_0.66.0_Linux-64bit.tar.gz
        sudo mv trivy /usr/local/bin/

    - name: Run Trivy SCA Scan
      shell: bash
      run: |
        trivy fs --skip-version-check --severity HIGH,CRITICAL \
          --format json --output trivy-sca.json . || true
        trivy fs --skip-version-check --severity HIGH,CRITICAL \
          --format template --template "@contrib/html.tpl" --output trivy-sca.html . || true

    - name: Upload HTML Report
      uses: actions/upload-artifact@v4
      with:
        name: sca-report-html
        path: trivy-sca.html

    - name: Install Python Dependencies
      shell: bash
      run: pip install openai==1.3.5

    - name: Run AI Analysis
      shell: bash
      env:
        OPENAI_API_KEY: ${{ inputs.openai-api-key }}
      run: python3 .github/actions/sca-ai-analysis/analyze_trivy.py

    - name: Upload AI Suggestions
      uses: actions/upload-artifact@v4
      with:
        name: ai-remediation-suggestions
        path: ai-suggestions.txt
